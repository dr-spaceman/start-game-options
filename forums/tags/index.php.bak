<?
require ($_SERVER["DOCUMENT_ROOT"]."/bin/php/page.php");
require ($_SERVER["DOCUMENT_ROOT"]."/bin/php/class.forum.php");

$page = new page;
$page->title = "Videogam.in forums / tags";
$page->style[] = "/bin/css/forums.css";
$page->header();
$forum = new forum();

$since = $_GET['since'];

?>
<div id="forum">
	<h2><a href="/forums/">Forums</a> <span>/</span> Tags</h2>
	<h3>What people have been talking about since 
		<select onchange="window.location='?since='+this.options[this.selectedIndex].value">
			<option value="">forever</option>
			<option value="7"<?=($since == 7 ? ' selected="selected"' : '')?>>one week ago</option>
			<option value="31"<?=($since == 31 ? ' selected="selected"' : '')?>>one month ago</option>
			<option value="365"<?=($since == 365 ? ' selected="selected"' : '')?>>one year ago</option>
		</select>
	</h3>
	<?
	$query = "SELECT tag FROM forums_tags LEFT JOIN forums_topics USING (tid)";
	if($since) $query.= " WHERE last_post > DATE_ADD(CURDATE(), INTERVAL -".$since." DAY)";
	$res = mysql_query($query);
	if($topicnum = mysql_num_rows($res)) {
		?>
		<fieldset class="forum-tag-list">
			<legend><?=$topicnum?> Topics</legend>
			<?
			
			while($row = mysql_fetch_assoc($res)) {
				$tags[$row['tag']]++;
			}
			//randomize
			$aux = array();
			$keys = array_keys($tags);
			shuffle($keys);
			foreach($keys as $key) {
				$aux[$key] = $tags[$key];
				unset($tags[$key]);
    	}
    	$tags = $aux;
    	
			$mean = array_sum($tags) / count($tags);
			while(list($tag, $num) = each($tags)) {
				unset($tagwords);
				$fontsize = 5 + ($num * $mean);
				if($fontsize > 40) $fontsize = 40;
				if(strstr($tag, "gid:")) {
					$x = explode(":", $tag);
					$q = "SELECT title FROM games WHERE gid='$x[1]' LIMIT 1";
					$dat = mysql_fetch_object(mysql_query($q));
					$tagwords = stripslashes($dat->title);
				} elseif(!strstr($tag, ":")) $tagwords = $tag;
				if($tagwords) echo '<a href="/forums/?tag='.urlencode($tag).'" style="font-size:'.$fontsize.'pt" title="'.$num.' topic'.($num != 1 ? 's' : '').'">'.$tagwords.'</a>'."&nbsp;\n";
			}
			?>
		</fieldset>
		<?
	} else {
		echo "No topics discussed during this timeframe.";
	}
	?>
</div>
<?
$page->footer();

?>